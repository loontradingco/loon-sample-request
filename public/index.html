<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sample Request | Loon Trading Co.</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a1a1a;
      --primary-light: #333;
      --accent: #c9a86c;
      --bg: #faf9f7;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-light: #6b6b6b;
      --border: #e5e2dd;
      --success: #2d6a4f;
      --error: #9d4044;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
      min-height: 100vh;
    }
    
    h1, h2, h3 { font-family: 'Playfair Display', Georgia, serif; font-weight: 500; }
    
    .header {
      background: #ccedd9;
      color: #000;
      padding: 40px 24px;
      text-align: center;
    }
    
    .header img {
      max-width: 220px;
      height: auto;
      margin-bottom: 16px;
      filter: none;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 400;
      letter-spacing: 1px;
      margin-bottom: 8px;
      color: #000;
    }
    
    .header p { 
      font-size: 14px; 
      color: rgba(0,0,0,0.7);
      font-weight: 400;
      letter-spacing: 0.5px;
    }
    
    .tagline {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.15);
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 15px;
      color: rgba(255,255,255,0.6);
    }
    
    .container { max-width: 800px; margin: 0 auto; padding: 32px 24px; }
    
    .card {
      background: var(--card);
      border-radius: 4px;
      padding: 32px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }
    
    .card h2 { 
      font-size: 20px; 
      margin-bottom: 24px; 
      color: var(--text);
      font-weight: 500;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { 
      display: block; 
      font-weight: 500; 
      margin-bottom: 8px; 
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; 
      padding: 14px 16px; 
      border: 1px solid var(--border);
      border-radius: 4px; 
      font-size: 15px; 
      font-family: inherit;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
      outline: none; 
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26,26,26,0.08);
    }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }
    .search-box input {
      padding-left: 44px;
    }
    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      opacity: 0.5;
    }
    
    .wine-list { 
      max-height: 450px; 
      overflow-y: auto; 
      border: 1px solid var(--border); 
      border-radius: 4px;
    }
    
    .region-group { border-bottom: 1px solid var(--border); }
    .region-group:last-child { border-bottom: none; }
    
    .region-header {
      background: var(--primary);
      color: #fff;
      padding: 12px 20px; 
      font-weight: 500; 
      font-size: 14px;
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      font-family: 'Playfair Display', serif;
      letter-spacing: 0.5px;
    }
    .region-header:hover { background: var(--primary-light); }
    .region-header .toggle { 
      font-size: 10px; 
      opacity: 0.6;
      transition: transform 0.2s;
    }
    .region-group.collapsed .region-header .toggle { transform: rotate(-90deg); }
    .region-group.collapsed .region-content { display: none; }
    
    .producer-group { border-bottom: 1px solid var(--border); }
    .producer-group:last-child { border-bottom: none; }
    
    .producer-header { 
      padding: 10px 20px 10px 24px; 
      font-weight: 600; 
      font-size: 12px; 
      color: var(--text);
      background: #f8f7f5;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .producer-header:hover { background: #f0efed; }
    .producer-header .toggle {
      font-size: 10px;
      opacity: 0.5;
      transition: transform 0.2s;
    }
    .producer-group.collapsed .producer-header .toggle { transform: rotate(-90deg); }
    .producer-group.collapsed .producer-content { display: none; }
    
    .wine-item {
      padding: 12px 20px 12px 40px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f0eeea;
      transition: background 0.15s;
    }
    .wine-item:hover { background: #faf9f7; }
    .wine-item:last-child { border-bottom: none; }
    .wine-item.selected { background: #f0f7f0; }
    .wine-item.selected::before {
      content: '‚úì';
      position: absolute;
      left: 16px;
      color: var(--success);
      font-weight: bold;
    }
    .wine-item { position: relative; }
    
    .wine-name { font-size: 14px; font-weight: 500; }
    .wine-meta { font-size: 12px; color: var(--text-light); margin-top: 2px; }
    .wine-add {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .wine-add:hover { background: var(--primary-light); }
    .wine-item.selected .wine-add { background: var(--success); }
    
    .cart {
      background: #f8f7f5;
      border-radius: 4px;
      padding: 20px;
      margin-top: 20px;
    }
    .cart-title { 
      font-size: 13px; 
      font-weight: 600; 
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .cart-item:last-child { border-bottom: none; }
    .cart-remove {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      opacity: 0.7;
    }
    .cart-remove:hover { opacity: 1; }
    
    .btn {
      display: inline-block;
      padding: 16px 40px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      width: 100%;
    }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    
    .error-page {
      text-align: center;
      padding: 80px 24px;
    }
    .error-page h2 { font-size: 24px; margin-bottom: 16px; }
    .error-page p { color: var(--text-light); margin-bottom: 24px; }
    .error-page a { color: var(--primary); }
    
    .success-page {
      text-align: center;
      padding: 60px 24px;
    }
    .success-page .icon { font-size: 64px; margin-bottom: 24px; }
    .success-page h2 { font-size: 28px; margin-bottom: 16px; }
    .success-page p { color: var(--text-light); max-width: 400px; margin: 0 auto; }
    
    .footer {
      text-align: center;
      padding: 40px 24px;
      color: var(--text-light);
      font-size: 13px;
      border-top: 1px solid var(--border);
      margin-top: 40px;
    }
    .footer a { color: var(--text); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
    
    .social-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    
    .social-links a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(var(--primary-rgb), 0.1);
      color: var(--primary);
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .social-links a:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
    }
    
    .social-links svg {
      width: 20px;
      height: 20px;
    }
    
    .loading { text-align: center; padding: 60px; color: var(--text-light); }
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 12px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header class="header">
    <img src="/logo.png" alt="Loon Trading Co." onerror="this.style.display='none'">
    <h1>Sample Request</h1>
    <p>Select wines for your sample shipment</p>

  </header>
  
  <main class="container" id="app">
    <div class="loading" id="loadingIndicator">Loading wines<span id="loadingDots">...</span><br><span id="loadingStatus" style="font-size: 14px; opacity: 0.7;"></span></div>
  </main>
  
  <footer class="footer">
    <div class="social-links">
      <a href="https://www.linkedin.com/company/loontradingcompany/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/>
        </svg>
      </a>
      
      <a href="https://www.facebook.com/loontradingco/" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/>
        </svg>
      </a>
      
      <a href="https://www.instagram.com/loontradingco" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
        </svg>
      </a>
      
      <a href="https://www.tiktok.com/@loontradingco" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M16.6 5.82s.51.5 0 0A4.278 4.278 0 0 1 15.54 3h-3.09v12.4a2.592 2.592 0 0 1-2.59 2.5c-1.42 0-2.6-1.16-2.6-2.6 0-1.72 1.66-3.01 3.37-2.48V9.66c-3.45-.46-6.47 2.22-6.47 5.64 0 3.33 2.76 5.7 5.69 5.7 3.14 0 5.69-2.55 5.69-5.7V9.01a7.35 7.35 0 0 0 4.3 1.38V7.3s-1.88.09-3.24-1.48z"/>
        </svg>
      </a>
      
      <a href="https://www.youtube.com/@loontradingcompany" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47.13-1.33.22-2.65.28-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z"/>
        </svg>
      </a>
    </div>
    
    <p>¬© 2024 <a href="https://www.loontradingco.com">Loon Trading Co.</a></p>
    <p style="margin-top: 8px;">Questions? Contact <a href="mailto:office@loontradingco.com">office@loontradingco.com</a></p>
  </footer>
  
  <script>
    let wines = [];
    let selectedWines = [];
    let stateOptions = [];
    let priceListCompany = ''; // Company name from price list export
    
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const listId = params.get('list');
      
      if (!listId) {
        showError();
        return;
      }
      
      // Animate loading dots
      let dots = 0;
      const dotsEl = document.getElementById('loadingDots');
      const statusEl = document.getElementById('loadingStatus');
      const dotsInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        if (dotsEl) dotsEl.textContent = '.'.repeat(dots || 1);
      }, 400);
      
      try {
        // Load states first (quick)
        if (statusEl) statusEl.textContent = 'Loading territories...';
        const statesRes = await fetch('/api/states');
        if (statesRes.ok) {
          const statesData = await statesRes.json();
          stateOptions = statesData.states || [];
        }
        
        // Load wines (slower)
        if (statusEl) statusEl.textContent = 'Loading wines from database...';
        const winesRes = await fetch(`/api/price-list/${listId}`);
        
        clearInterval(dotsInterval);
        
        if (!winesRes.ok) throw new Error('Not found');
        const data = await winesRes.json();
        
        // Store company name from export
        priceListCompany = data.companyName || '';
        
        // Handle both old format (organized object) and new format (flat array)
        if (Array.isArray(data.products)) {
          wines = data.products;
        } else if (data.wines && typeof data.wines === 'object') {
          // Convert organized object to flat array for compatibility
          const wineArray = [];
          Object.entries(data.wines).forEach(([region, producers]) => {
            Object.entries(producers).forEach(([producer, prodWines]) => {
              prodWines.forEach(wine => {
                wineArray.push({ ...wine, region, producer });
              });
            });
          });
          wines = wineArray;
        }
        
        document.querySelector('h1').textContent = data.displayName || data.name || 'Sample Request';
        renderForm();
      } catch (err) {
        clearInterval(dotsInterval);
        showError();
      }
    }
    
    function showError() {
      document.getElementById('app').innerHTML = `
        <div class="error-page">
          <h2>Price List Not Found</h2>
          <p>No price list specified. Please use a valid sample request link.</p>
          <p>For assistance, please contact <a href="mailto:office@loontradingco.com">office@loontradingco.com</a></p>
        </div>
      `;
    }
    
    function renderForm() {
      // Group by region then producer
      const grouped = {};
      wines.forEach(w => {
        const region = w.region || 'Other';
        const producer = w.producer || 'Unknown';
        if (!grouped[region]) grouped[region] = {};
        if (!grouped[region][producer]) grouped[region][producer] = [];
        grouped[region][producer].push(w);
      });
      
      // Sort regions alphabetically, with 'Other' at the end
      const sortedRegions = Object.keys(grouped).sort((a, b) => {
        if (a === 'Other') return 1;
        if (b === 'Other') return -1;
        return a.localeCompare(b);
      });
      
      document.getElementById('app').innerHTML = `
        <div class="card">
          <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <span>Select Samples</span>
            <span style="font-size: 14px; font-weight: normal; color: #666;">${wines.length} products</span>
          </h2>
          <div class="search-box">
            <input type="text" id="wineSearch" placeholder="Search wines, producers, or regions...">
          </div>
          <div class="wine-list" id="wineList">
            ${sortedRegions.map(region => {
              // Sort producers alphabetically within each region, with 'Unknown' at the end
              const sortedProducers = Object.keys(grouped[region]).sort((a, b) => {
                if (a === 'Unknown') return 1;
                if (b === 'Unknown') return -1;
                return a.localeCompare(b);
              });
              
              return `
              <div class="region-group" data-region="${region}">
                <div class="region-header" onclick="toggleRegion(this)">
                  <span>${region}</span>
                  <span class="toggle">‚ñº</span>
                </div>
                <div class="region-content">
                  ${sortedProducers.map(producer => {
                    const prodWines = grouped[region][producer];
                    // Sort wines alphabetically by name
                    prodWines.sort((a, b) => a.name.localeCompare(b.name));
                    
                    return `
                    <div class="producer-group" data-producer="${producer}">
                      <div class="producer-header" onclick="toggleProducer(this)">
                        <span>${producer}</span>
                        <span class="toggle">‚ñº</span>
                      </div>
                      <div class="producer-content">
                        ${prodWines.map(w => `
                          <div class="wine-item" data-id="${w.id}" onclick="toggleWine('${w.id}')">
                            <div>
                              <div class="wine-name">${w.name}</div>
                              <div class="wine-meta">${[w.vintage, w.color].filter(Boolean).join(' ‚Ä¢ ')}</div>
                            </div>
                            <button class="wine-add">${selectedWines.find(s => s.id === w.id) ? '‚úì Added' : 'Add'}</button>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  `}).join('')}
                </div>
              </div>
            `}).join('')}
          </div>
          <div class="cart" id="cart" style="display: ${selectedWines.length ? 'block' : 'none'}">
            <div class="cart-title">Selected Wines (${selectedWines.length})</div>
            <div id="cartItems"></div>
          </div>
        </div>
        
        <div class="card">
          <h2>Contact Information</h2>
          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="company" required value="${priceListCompany}">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" id="firstName" required>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" id="lastName" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="email" required>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="phone">
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>Shipping Address</h2>
          <div class="form-group">
            <label>Street Address *</label>
            <input type="text" id="address1" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City *</label>
              <input type="text" id="city" required>
            </div>
            <div class="form-group">
              <label>State / Region *</label>
              <select id="state" required>
                <option value="">Select state...</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ZIP / Postal Code *</label>
              <input type="text" id="zip" required>
            </div>
            <div class="form-group">
              <label>Country *</label>
              <select id="country" required>
                <option value="United States" selected>United States</option>
                <option value="Canada">Canada</option>
                <option value="Mexico">Mexico</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>Additional Information</h2>
          <div class="form-group">
            <label>Special Instructions or Comments</label>
            <textarea id="comments" rows="4" placeholder="Delivery instructions, timing preferences, etc."></textarea>
          </div>
        </div>
        
        <button class="btn btn-primary" id="submitBtn" onclick="submitRequest()">
          Submit Sample Request
        </button>
      `;
      
      document.getElementById('wineSearch').addEventListener('input', filterWines);
      populateStates();
      updateCart();
    }
    
    function toggleRegion(header) {
      header.parentElement.classList.toggle('collapsed');
    }
    
    function toggleProducer(header) {
      header.parentElement.classList.toggle('collapsed');
    }
    
    function toggleWine(id) {
      const wine = wines.find(w => w.id === id);
      if (!wine) return;
      
      const idx = selectedWines.findIndex(w => w.id === id);
      if (idx >= 0) {
        selectedWines.splice(idx, 1);
      } else {
        selectedWines.push(wine);
      }
      
      updateWineUI(id);
      updateCart();
    }
    
    function updateWineUI(id) {
      const item = document.querySelector(`.wine-item[data-id="${id}"]`);
      if (!item) return;
      
      const isSelected = selectedWines.find(w => w.id === id);
      item.classList.toggle('selected', !!isSelected);
      item.querySelector('.wine-add').textContent = isSelected ? '‚úì Added' : 'Add';
    }
    
    function updateCart() {
      const cart = document.getElementById('cart');
      const cartItems = document.getElementById('cartItems');
      
      cart.style.display = selectedWines.length ? 'block' : 'none';
      document.querySelector('.cart-title').textContent = `Selected Wines (${selectedWines.length})`;
      
      cartItems.innerHTML = selectedWines.map(w => {
        const details = [w.vintage, w.color].filter(Boolean).join(' ');
        const displayName = details ? `${w.name} (${details})` : w.name;
        return `
          <div class="cart-item">
            <span>${displayName} <span style="color: var(--text-light);">- ${w.producer}</span></span>
            <button class="cart-remove" onclick="event.stopPropagation(); toggleWine('${w.id}')">√ó</button>
          </div>
        `;
      }).join('');
    }
    
    function filterWines() {
      const query = document.getElementById('wineSearch').value.toLowerCase();
      document.querySelectorAll('.wine-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? '' : 'none';
      });
      document.querySelectorAll('.producer-header').forEach(header => {
        const text = header.textContent.toLowerCase();
        const hasVisible = header.nextElementSibling && 
          [...header.parentElement.querySelectorAll('.wine-item')].some(i => i.style.display !== 'none');
      });
    }
    
    async function submitRequest() {
      const btn = document.getElementById('submitBtn');
      
      if (selectedWines.length === 0) {
        alert('Please select at least one wine.');
        return;
      }
      
      const required = ['company', 'firstName', 'lastName', 'email', 'address1', 'city', 'state', 'zip', 'country'];
      for (const id of required) {
        if (!document.getElementById(id).value.trim()) {
          alert('Please fill in all required fields.');
          document.getElementById(id).focus();
          return;
        }
      }
      
      btn.disabled = true;
      btn.textContent = 'Submitting...';
      
      try {
        const res = await fetch('/api/sample-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wines: selectedWines,
            contact: {
              company: document.getElementById('company').value,
              firstName: document.getElementById('firstName').value,
              lastName: document.getElementById('lastName').value,
              email: document.getElementById('email').value,
              phone: document.getElementById('phone').value
            },
            shipping: {
              address1: document.getElementById('address1').value,
              city: document.getElementById('city').value,
              state: document.getElementById('state').value,
              zip: document.getElementById('zip').value,
              country: document.getElementById('country').value
            },
            comments: document.getElementById('comments').value
          })
        });
        
        if (res.ok) {
          document.getElementById('app').innerHTML = `
            <div class="success-page">
              <div class="icon">‚úì</div>
              <h2>Request Submitted</h2>
              <p>Thank you! We've received your sample request and will be in touch shortly.</p>
              <p style="margin-top: 8px;">A confirmation email has been sent to your email address.</p>
              <button class="btn btn-primary" style="max-width: 300px; margin-top: 32px;" onclick="location.reload()">
                Submit Another Request
              </button>
            </div>
          `;
        } else {
          throw new Error('Submit failed');
        }
      } catch (err) {
        alert('There was an error submitting your request. Please try again or contact office@loontradingco.com');
        btn.disabled = false;
        btn.textContent = 'Submit Sample Request';
      }
    }
    
    // Populate state dropdown
    function populateStates() {
      const stateSelect = document.getElementById('state');
      if (!stateSelect || stateOptions.length === 0) return;
      
      let html = '<option value="">Select state...</option>';
      stateOptions.forEach(s => {
        html += `<option value="${s.name}" data-country="${s.country || 'United States'}">${s.name}${s.abbrev ? ` (${s.abbrev})` : ''}</option>`;
      });
      stateSelect.innerHTML = html;
      
      // Add change handler to auto-select country
      stateSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const country = selectedOption.dataset.country;
        if (country) {
          document.getElementById('country').value = country;
        }
      });
    }
    
    init();
  </script>
</body>
</html>
