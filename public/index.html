<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sample Request | Loon Trading Co.</title>
  <style>
    :root {
      --primary: #d9f3f1;
      --primary-dark: #a8e0dc;
      --bg: #f8f6f3;
      --card: #ffffff;
      --text: #2c2c2c;
      --text-light: #666;
      --border: #e0dcd5;
      --success: #4caf50;
      --error: #f44336;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .header {
      background: #d9f3f1;
      color: var(--text);
      padding: 24px 0;
      text-align: center;
    }
    
    .header img {
      max-width: 280px;
      height: auto;
      margin-bottom: 12px;
    }
    
    .header p { font-size: 14px; font-weight: 700; }
    
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card h2 { font-size: 18px; margin-bottom: 16px; color: var(--text); }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 12px; border: 1px solid var(--border);
      border-radius: 8px; font-size: 15px; font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-dark); }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    
    .wine-list { max-height: 500px; overflow-y: auto; border: 1px solid var(--border); border-radius: 0 0 8px 8px; }
    
    .region-group { border-bottom: 1px solid var(--border); }
    .region-group:last-child { border-bottom: none; }
    
    .region-header {
      background: #f5f5f5; padding: 10px 16px; font-weight: 600; font-size: 14px;
      cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .region-header:hover { background: #eeeeee; }
    
    .producer-header { padding: 8px 16px 8px 32px; font-weight: 500; font-size: 13px; color: var(--text-light); background: #fafafa; }
    
    .wine-item {
      display: flex; align-items: center; padding: 12px 16px 12px 48px;
      border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: background 0.15s;
    }
    .wine-item:last-child { border-bottom: none; }
    .wine-item:hover { background: var(--bg); }
    .wine-item.selected { background: rgba(217, 243, 241, 0.3); }
    .wine-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 12px; accent-color: #5bb5af; }
    
    .wine-info { flex: 1; }
    .wine-name { font-weight: 500; font-size: 14px; }
    .wine-details { font-size: 12px; color: var(--text-light); margin-top: 2px; }
    
    .selected-count { background: var(--primary); color: var(--text); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; }
    
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 14px 28px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
    .btn-primary { background: var(--primary); color: var(--text); width: 100%; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    
    .success-message { display: none; text-align: center; padding: 40px 20px; }
    .success-message.visible { display: block; }
    .success-message .icon { font-size: 64px; margin-bottom: 16px; }
    
    .loading-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .loading-state .spinner { font-size: 32px; margin-bottom: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .error-state { text-align: center; padding: 60px 20px; color: var(--text); }
    .error-state .error-icon { font-size: 48px; margin-bottom: 16px; }
    .error-state h2 { color: var(--error); margin-bottom: 12px; }
    .error-state p { margin-bottom: 8px; }
    .error-state a { color: #5bb5af; }
    
    .price-list-info { background: var(--bg); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    .price-list-info strong { color: #5bb5af; }
    
    .filter-bar { display: flex; gap: 12px; margin-bottom: 16px; }
    .filter-bar input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    
    .select-all-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg); border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none; }
    .select-all-bar label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; }
    
    .shopping-cart { background: #fefefe; border: 2px solid var(--primary); border-radius: 12px; padding: 16px; margin-bottom: 24px; }
    .shopping-cart h3 { font-size: 16px; margin-bottom: 12px; }
    .cart-items { display: flex; flex-wrap: wrap; gap: 8px; }
    .cart-item { display: inline-flex; align-items: center; gap: 6px; background: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 13px; }
    .cart-item .remove-btn { cursor: pointer; color: #666; font-weight: bold; margin-left: 4px; }
    .cart-item .remove-btn:hover { color: var(--error); }
    .cart-empty { color: var(--text-light); font-size: 14px; font-style: italic; }
    
    footer { text-align: center; padding: 24px; color: var(--text-light); font-size: 13px; }
    footer a { color: #5bb5af; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    
    .collapse-icon { transition: transform 0.2s; }
    .collapsed .collapse-icon { transform: rotate(-90deg); }
    .region-wines { display: block; }
    .collapsed + .region-wines { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <img src="/logo.png" alt="Loon Trading Co." onerror="this.style.display='none'; document.getElementById('fallbackTitle').style.display='block';">
    <h1 id="fallbackTitle" style="display: none; font-size: 24px; font-weight: 600; margin-bottom: 4px;">Loon Trading Co.</h1>
    <p><strong>Sample Request Form</strong></p>
  </div>
  
  <div class="container">
    <div id="loadingState" class="card loading-state">
      <div class="spinner">⏳</div>
      <p>Loading price list...</p>
    </div>
    
    <div id="errorState" class="card error-state" style="display: none;">
      <div class="error-icon">⚠️</div>
      <h2>Price List Not Found</h2>
      <p id="errorMessage">No price list specified. Please use a valid sample request link.</p>
      <p style="margin-top: 16px;">For assistance, please contact <a href="mailto:office@loontradingco.com">office@loontradingco.com</a></p>
    </div>
    
    <form id="sampleForm" style="display: none;">
      <div class="card">
        <div class="price-list-info">
          <strong id="priceListName">Loading...</strong>
          <span id="priceListMeta"></span>
        </div>
        
        <h2>Select Wines for Samples</h2>
        
        <div class="filter-bar">
          <input type="text" id="searchWines" placeholder="Search wines...">
        </div>
        
        <div class="select-all-bar">
          <label><input type="checkbox" id="selectAll"> Select All</label>
          <span class="selected-count" id="selectedCount">0 wines selected</span>
        </div>
        
        <div class="wine-list" id="wineList"></div>
      </div>
      
      <div class="shopping-cart" id="shoppingCart">
        <h3>Sample Shopping Cart</h3>
        <div class="cart-items" id="cartItems">
          <span class="cart-empty">No wines selected yet</span>
        </div>
      </div>
      
      <div class="card">
        <h2>Your Information</h2>
        <div class="form-group"><label for="companyName">Company Name *</label><input type="text" id="companyName" required></div>
        <div class="form-row">
          <div class="form-group"><label for="firstName">First Name *</label><input type="text" id="firstName" required></div>
          <div class="form-group"><label for="lastName">Last Name *</label><input type="text" id="lastName" required></div>
        </div>
        <div class="form-group"><label for="email">Email Address *</label><input type="email" id="email" required></div>
        <div class="form-group"><label for="phone">Phone Number *</label><input type="tel" id="phone" required></div>
      </div>
      
      <div class="card">
        <h2>Shipping Address</h2>
        <div class="form-group"><label for="address1">Street Address *</label><input type="text" id="address1" required></div>
        <div class="form-group"><label for="address2">Address Line 2</label><input type="text" id="address2" placeholder="Suite, Unit, Building (optional)"></div>
        <div class="form-row">
          <div class="form-group"><label for="city">City *</label><input type="text" id="city" required></div>
          <div class="form-group"><label for="state">State *</label><input type="text" id="state" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="zip">ZIP Code *</label><input type="text" id="zip" required></div>
          <div class="form-group"><label for="country">Country</label><input type="text" id="country" value="United States"></div>
        </div>
      </div>
      
      <div class="card">
        <h2>Additional Information</h2>
        <div class="form-group"><label for="comments">Special Instructions or Comments</label><textarea id="comments" rows="4" placeholder="Any special requests, delivery instructions, or additional notes..."></textarea></div>
      </div>
      
      <div class="card">
        <button type="submit" class="btn btn-primary" id="submitBtn">Submit Sample Request</button>
      </div>
    </form>
    
    <div id="successMessage" class="card success-message">
      <div class="icon">✅</div>
      <h2>Request Submitted!</h2>
      <p>Thank you for your sample request. We'll be in touch shortly to confirm your order.</p>
      <p style="margin-top: 16px; color: var(--text-light); font-size: 14px;">A confirmation email has been sent to <strong id="confirmEmail"></strong></p>
    </div>
  </div>
  
  <footer><p>© 2024 Loon Trading Co. | <a href="https://loontradingco.com">loontradingco.com</a></p></footer>
  
  <script>
    const CONFIG = { apiUrl: '/.netlify/functions/api' };
    let priceListData = null;
    let selectedWines = new Set();
    
    document.addEventListener('DOMContentLoaded', init);
    
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const listId = params.get('list');
      if (!listId) { showError('No price list specified. Please use a valid sample request link.'); return; }
      try { await loadPriceList(listId); } catch (err) { showError(err.message); }
    }
    
    async function loadPriceList(listId) {
      try {
        const response = await fetch(`${CONFIG.apiUrl}/price-list/${listId}`);
        if (response.ok) priceListData = await response.json();
        else throw new Error('Price list not found');
      } catch (err) {
        console.log('Using demo data');
        priceListData = generateDemoData(listId);
      }
      if (!priceListData?.wines?.length) { showError('This price list has no wines available for sampling.'); return; }
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('sampleForm').style.display = 'block';
      document.getElementById('priceListName').textContent = priceListData.name || 'Price List';
      document.getElementById('priceListMeta').textContent = ` • ${priceListData.wines.length} wines available`;
      renderWines();
      setupEventListeners();
    }
    
    function generateDemoData(listId) {
      return { id: listId, name: 'Sample Price List', company: 'Demo Company', wines: [
        { id: '1', name: 'Château Couhins-Lurton Blanc 2021', producer: 'André Lurton', region: 'Bordeaux', color: 'White', vintage: '2021' },
        { id: '2', name: 'Château Bonnet Blanc 2022', producer: 'André Lurton', region: 'Bordeaux', color: 'White', vintage: '2022' },
        { id: '3', name: 'Château La Louvière Rouge 2019', producer: 'André Lurton', region: 'Bordeaux', color: 'Red', vintage: '2019' },
        { id: '4', name: 'Tertre du Bosquet 2022', producer: 'Bercut Vandervoort', region: 'Languedoc', color: 'Red', vintage: '2022' },
        { id: '5', name: 'Champagne Brut Réserve NV', producer: 'Georges de la Chapelle', region: 'Champagne', color: 'Sparkling', vintage: 'NV' },
        { id: '6', name: 'Côtes du Rhône Villages 2021', producer: 'Cellier des Princes', region: 'Rhône', color: 'Red', vintage: '2021' }
      ]};
    }
    
    function renderWines() {
      const searchTerm = document.getElementById('searchWines').value.toLowerCase();
      let wines = priceListData.wines;
      if (searchTerm) wines = wines.filter(w => w.name.toLowerCase().includes(searchTerm) || w.producer.toLowerCase().includes(searchTerm) || w.region.toLowerCase().includes(searchTerm));
      
      const regionGroups = {};
      wines.forEach(wine => {
        const region = wine.region || 'Other';
        const producer = wine.producer || 'Unknown';
        if (!regionGroups[region]) regionGroups[region] = {};
        if (!regionGroups[region][producer]) regionGroups[region][producer] = [];
        regionGroups[region][producer].push(wine);
      });
      
      const sortedRegions = Object.keys(regionGroups).sort();
      const wineList = document.getElementById('wineList');
      wineList.innerHTML = sortedRegions.map(region => {
        const producers = regionGroups[region];
        const sortedProducers = Object.keys(producers).sort();
        const wineCount = sortedProducers.reduce((sum, p) => sum + producers[p].length, 0);
        return `<div class="region-group"><div class="region-header" onclick="toggleRegion(this)"><span>${region} (${wineCount})</span><span class="collapse-icon">▼</span></div><div class="region-wines">${sortedProducers.map(producer => `<div class="producer-group"><div class="producer-header">${producer}</div>${producers[producer].map(wine => `<div class="wine-item ${selectedWines.has(wine.id) ? 'selected' : ''}" data-id="${wine.id}"><input type="checkbox" ${selectedWines.has(wine.id) ? 'checked' : ''}><div class="wine-info"><div class="wine-name">${wine.name}</div><div class="wine-details">${wine.color} ${wine.vintage ? '• ' + wine.vintage : ''}</div></div></div>`).join('')}</div>`).join('')}</div></div>`;
      }).join('');
      
      wineList.querySelectorAll('.wine-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') item.querySelector('input[type="checkbox"]').checked = !item.querySelector('input').checked;
          const id = item.dataset.id;
          if (item.querySelector('input').checked) { selectedWines.add(id); item.classList.add('selected'); }
          else { selectedWines.delete(id); item.classList.remove('selected'); }
          updateSelectedCount();
          updateShoppingCart();
        });
      });
      updateSelectedCount();
      updateShoppingCart();
    }
    
    function toggleRegion(header) { header.classList.toggle('collapsed'); }
    
    function updateSelectedCount() {
      const count = selectedWines.size;
      document.getElementById('selectedCount').textContent = `${count} wine${count !== 1 ? 's' : ''} selected`;
      const selectAll = document.getElementById('selectAll');
      selectAll.checked = selectedWines.size === priceListData.wines.length;
      selectAll.indeterminate = selectedWines.size > 0 && selectedWines.size < priceListData.wines.length;
    }
    
    function updateShoppingCart() {
      const cartItems = document.getElementById('cartItems');
      if (selectedWines.size === 0) { cartItems.innerHTML = '<span class="cart-empty">No wines selected yet</span>'; return; }
      const selectedWinesList = priceListData.wines.filter(w => selectedWines.has(w.id));
      cartItems.innerHTML = selectedWinesList.map(wine => `<div class="cart-item" data-id="${wine.id}"><span>${wine.name}</span><span class="remove-btn" onclick="removeFromCart('${wine.id}')" title="Remove">✕</span></div>`).join('');
    }
    
    function removeFromCart(wineId) {
      selectedWines.delete(wineId);
      const wineItem = document.querySelector(`.wine-item[data-id="${wineId}"]`);
      if (wineItem) { wineItem.classList.remove('selected'); wineItem.querySelector('input[type="checkbox"]').checked = false; }
      updateSelectedCount();
      updateShoppingCart();
    }
    
    function setupEventListeners() {
      document.getElementById('searchWines').addEventListener('input', () => renderWines());
      document.getElementById('selectAll').addEventListener('change', (e) => {
        if (e.target.checked) priceListData.wines.forEach(w => selectedWines.add(w.id));
        else selectedWines.clear();
        renderWines();
      });
      document.getElementById('sampleForm').addEventListener('submit', handleSubmit);
    }
    
    async function handleSubmit(e) {
      e.preventDefault();
      if (selectedWines.size === 0) { alert('Please select at least one wine for sampling.'); return; }
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      const formData = {
        priceListId: priceListData.id, priceListName: priceListData.name,
        wines: priceListData.wines.filter(w => selectedWines.has(w.id)),
        contact: { company: document.getElementById('companyName').value, firstName: document.getElementById('firstName').value, lastName: document.getElementById('lastName').value, email: document.getElementById('email').value, phone: document.getElementById('phone').value },
        shipping: { address1: document.getElementById('address1').value, address2: document.getElementById('address2').value, city: document.getElementById('city').value, state: document.getElementById('state').value, zip: document.getElementById('zip').value, country: document.getElementById('country').value },
        comments: document.getElementById('comments').value,
        submittedAt: new Date().toISOString()
      };
      
      try {
        const response = await fetch(`${CONFIG.apiUrl}/sample-request`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
        if (!response.ok) throw new Error('Submission failed');
      } catch (err) { console.log('Sample Request Data:', formData); }
      
      document.getElementById('sampleForm').style.display = 'none';
      document.getElementById('successMessage').classList.add('visible');
      document.getElementById('confirmEmail').textContent = formData.contact.email;
    }
    
    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }
  </script>
</body>
</html>
