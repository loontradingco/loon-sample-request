<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sample Request | Loon Trading Co.</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a1a1a;
      --primary-light: #333;
      --accent: #c9a86c;
      --bg: #faf9f7;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-light: #6b6b6b;
      --border: #e5e2dd;
      --success: #2d6a4f;
      --error: #9d4044;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
      min-height: 100vh;
    }
    
    h1, h2, h3 { font-family: 'Playfair Display', Georgia, serif; font-weight: 500; }
    
    .header {
      background: var(--primary);
      color: #fff;
      padding: 40px 24px;
      text-align: center;
    }
    
    .header img {
      max-width: 220px;
      height: auto;
      margin-bottom: 16px;
      filter: brightness(0) invert(1);
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 400;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .header p { 
      font-size: 14px; 
      color: rgba(255,255,255,0.7);
      font-weight: 400;
      letter-spacing: 0.5px;
    }
    
    .tagline {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.15);
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 15px;
      color: rgba(255,255,255,0.6);
    }
    
    .container { max-width: 800px; margin: 0 auto; padding: 32px 24px; }
    
    .card {
      background: var(--card);
      border-radius: 4px;
      padding: 32px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }
    
    .card h2 { 
      font-size: 20px; 
      margin-bottom: 24px; 
      color: var(--text);
      font-weight: 500;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { 
      display: block; 
      font-weight: 500; 
      margin-bottom: 8px; 
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; 
      padding: 14px 16px; 
      border: 1px solid var(--border);
      border-radius: 4px; 
      font-size: 15px; 
      font-family: inherit;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
      outline: none; 
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26,26,26,0.08);
    }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }
    .search-box input {
      padding-left: 44px;
    }
    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      opacity: 0.5;
    }
    
    .wine-list { 
      max-height: 450px; 
      overflow-y: auto; 
      border: 1px solid var(--border); 
      border-radius: 4px;
    }
    
    .region-group { border-bottom: 1px solid var(--border); }
    .region-group:last-child { border-bottom: none; }
    
    .region-header {
      background: var(--primary);
      color: #fff;
      padding: 12px 20px; 
      font-weight: 500; 
      font-size: 14px;
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      font-family: 'Playfair Display', serif;
      letter-spacing: 0.5px;
    }
    .region-header:hover { background: var(--primary-light); }
    .region-header .toggle { 
      font-size: 10px; 
      opacity: 0.6;
      transition: transform 0.2s;
    }
    .region-group.collapsed .region-header .toggle { transform: rotate(-90deg); }
    .region-group.collapsed .region-content { display: none; }
    
    .producer-header { 
      padding: 10px 20px 10px 24px; 
      font-weight: 600; 
      font-size: 12px; 
      color: var(--text);
      background: #f8f7f5;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }
    
    .wine-item {
      padding: 12px 20px 12px 40px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f0eeea;
      transition: background 0.15s;
    }
    .wine-item:hover { background: #faf9f7; }
    .wine-item:last-child { border-bottom: none; }
    .wine-item.selected { background: #f0f7f0; }
    .wine-item.selected::before {
      content: '‚úì';
      position: absolute;
      left: 16px;
      color: var(--success);
      font-weight: bold;
    }
    .wine-item { position: relative; }
    
    .wine-name { font-size: 14px; font-weight: 500; }
    .wine-meta { font-size: 12px; color: var(--text-light); margin-top: 2px; }
    .wine-add {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .wine-add:hover { background: var(--primary-light); }
    .wine-item.selected .wine-add { background: var(--success); }
    
    .cart {
      background: #f8f7f5;
      border-radius: 4px;
      padding: 20px;
      margin-top: 20px;
    }
    .cart-title { 
      font-size: 13px; 
      font-weight: 600; 
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .cart-item:last-child { border-bottom: none; }
    .cart-remove {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      opacity: 0.7;
    }
    .cart-remove:hover { opacity: 1; }
    
    .btn {
      display: inline-block;
      padding: 16px 40px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      width: 100%;
    }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    
    .error-page {
      text-align: center;
      padding: 80px 24px;
    }
    .error-page h2 { font-size: 24px; margin-bottom: 16px; }
    .error-page p { color: var(--text-light); margin-bottom: 24px; }
    .error-page a { color: var(--primary); }
    
    .success-page {
      text-align: center;
      padding: 60px 24px;
    }
    .success-page .icon { font-size: 64px; margin-bottom: 24px; }
    .success-page h2 { font-size: 28px; margin-bottom: 16px; }
    .success-page p { color: var(--text-light); max-width: 400px; margin: 0 auto; }
    
    .footer {
      text-align: center;
      padding: 40px 24px;
      color: var(--text-light);
      font-size: 13px;
      border-top: 1px solid var(--border);
      margin-top: 40px;
    }
    .footer a { color: var(--text); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
    
    .loading { text-align: center; padding: 60px; color: var(--text-light); }
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 12px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header class="header">
    <img src="/logo.png" alt="Loon Trading Co." onerror="this.style.display='none'">
    <h1>Sample Request</h1>
    <p>Select wines for your sample shipment</p>
    <div class="tagline">Relationships. Strategy. Integrity.</div>
  </header>
  
  <main class="container" id="app">
    <div class="loading">Loading wines...</div>
  </main>
  
  <footer class="footer">
    <p>¬© 2024 <a href="https://www.loontradingco.com">Loon Trading Co.</a></p>
    <p style="margin-top: 8px;">Questions? Contact <a href="mailto:office@loontradingco.com">office@loontradingco.com</a></p>
  </footer>
  
  <script>
    let wines = [];
    let selectedWines = [];
    let stateOptions = [];
    
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const listId = params.get('list');
      
      if (!listId) {
        showError();
        return;
      }
      
      try {
        // Load states and wines in parallel
        const [statesRes, winesRes] = await Promise.all([
          fetch('/api/states'),
          fetch(`/api/price-list/${listId}`)
        ]);
        
        if (statesRes.ok) {
          const statesData = await statesRes.json();
          stateOptions = statesData.states || [];
        }
        
        if (!winesRes.ok) throw new Error('Not found');
        const data = await winesRes.json();
        wines = data.wines || [];
        renderForm();
      } catch (err) {
        showError();
      }
    }
    
    function showError() {
      document.getElementById('app').innerHTML = `
        <div class="error-page">
          <h2>Price List Not Found</h2>
          <p>No price list specified. Please use a valid sample request link.</p>
          <p>For assistance, please contact <a href="mailto:office@loontradingco.com">office@loontradingco.com</a></p>
        </div>
      `;
    }
    
    function renderForm() {
      // Group by region then producer
      const grouped = {};
      wines.forEach(w => {
        const region = w.region || 'Other';
        const producer = w.producer || 'Unknown';
        if (!grouped[region]) grouped[region] = {};
        if (!grouped[region][producer]) grouped[region][producer] = [];
        grouped[region][producer].push(w);
      });
      
      document.getElementById('app').innerHTML = `
        <div class="card">
          <h2>Select Wines</h2>
          <div class="search-box">
            <input type="text" id="wineSearch" placeholder="Search wines, producers, or regions...">
          </div>
          <div class="wine-list" id="wineList">
            ${Object.entries(grouped).map(([region, producers]) => `
              <div class="region-group" data-region="${region}">
                <div class="region-header" onclick="toggleRegion(this)">
                  <span>${region}</span>
                  <span class="toggle">‚ñº</span>
                </div>
                <div class="region-content">
                  ${Object.entries(producers).map(([producer, prodWines]) => `
                    <div class="producer-header">${producer}</div>
                    ${prodWines.map(w => `
                      <div class="wine-item" data-id="${w.id}" onclick="toggleWine('${w.id}')">
                        <div>
                          <div class="wine-name">${w.name}</div>
                          <div class="wine-meta">${w.vintage || ''} ${w.color || ''}</div>
                        </div>
                        <button class="wine-add">${selectedWines.find(s => s.id === w.id) ? '‚úì Added' : 'Add'}</button>
                      </div>
                    `).join('')}
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
          <div class="cart" id="cart" style="display: ${selectedWines.length ? 'block' : 'none'}">
            <div class="cart-title">Selected Wines (${selectedWines.length})</div>
            <div id="cartItems"></div>
          </div>
        </div>
        
        <div class="card">
          <h2>Contact Information</h2>
          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="company" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" id="firstName" required>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" id="lastName" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="email" required>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="phone">
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>Shipping Address</h2>
          <div class="form-group">
            <label>Street Address *</label>
            <input type="text" id="address1" required>
          </div>
          <div class="form-group">
            <label>Address Line 2</label>
            <input type="text" id="address2">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City *</label>
              <input type="text" id="city" required>
            </div>
            <div class="form-group">
              <label>State / Region *</label>
              <select id="state" required>
                <option value="">Select state...</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ZIP / Postal Code *</label>
              <input type="text" id="zip" required>
            </div>
            <div class="form-group">
              <label>Country *</label>
              <select id="country" required>
                <option value="United States" selected>United States</option>
                <option value="Canada">Canada</option>
                <option value="Mexico">Mexico</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>Additional Information</h2>
          <div class="form-group">
            <label>Special Instructions or Comments</label>
            <textarea id="comments" rows="4" placeholder="Delivery instructions, timing preferences, etc."></textarea>
          </div>
        </div>
        
        <button class="btn btn-primary" id="submitBtn" onclick="submitRequest()">
          Submit Sample Request
        </button>
      `;
      
      document.getElementById('wineSearch').addEventListener('input', filterWines);
      populateStates();
      updateCart();
    }
    
    function toggleRegion(header) {
      header.parentElement.classList.toggle('collapsed');
    }
    
    function toggleWine(id) {
      const wine = wines.find(w => w.id === id);
      if (!wine) return;
      
      const idx = selectedWines.findIndex(w => w.id === id);
      if (idx >= 0) {
        selectedWines.splice(idx, 1);
      } else {
        selectedWines.push(wine);
      }
      
      updateWineUI(id);
      updateCart();
    }
    
    function updateWineUI(id) {
      const item = document.querySelector(`.wine-item[data-id="${id}"]`);
      if (!item) return;
      
      const isSelected = selectedWines.find(w => w.id === id);
      item.classList.toggle('selected', !!isSelected);
      item.querySelector('.wine-add').textContent = isSelected ? '‚úì Added' : 'Add';
    }
    
    function updateCart() {
      const cart = document.getElementById('cart');
      const cartItems = document.getElementById('cartItems');
      
      cart.style.display = selectedWines.length ? 'block' : 'none';
      document.querySelector('.cart-title').textContent = `Selected Wines (${selectedWines.length})`;
      
      cartItems.innerHTML = selectedWines.map(w => `
        <div class="cart-item">
          <span>${w.name} <span style="color: var(--text-light);">- ${w.producer}</span></span>
          <button class="cart-remove" onclick="event.stopPropagation(); toggleWine('${w.id}')">√ó</button>
        </div>
      `).join('');
    }
    
    function filterWines() {
      const query = document.getElementById('wineSearch').value.toLowerCase();
      document.querySelectorAll('.wine-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? '' : 'none';
      });
      document.querySelectorAll('.producer-header').forEach(header => {
        const text = header.textContent.toLowerCase();
        const hasVisible = header.nextElementSibling && 
          [...header.parentElement.querySelectorAll('.wine-item')].some(i => i.style.display !== 'none');
      });
    }
    
    async function submitRequest() {
      const btn = document.getElementById('submitBtn');
      
      if (selectedWines.length === 0) {
        alert('Please select at least one wine.');
        return;
      }
      
      const required = ['company', 'firstName', 'lastName', 'email', 'address1', 'city', 'state', 'zip', 'country'];
      for (const id of required) {
        if (!document.getElementById(id).value.trim()) {
          alert('Please fill in all required fields.');
          document.getElementById(id).focus();
          return;
        }
      }
      
      btn.disabled = true;
      btn.textContent = 'Submitting...';
      
      try {
        const res = await fetch('/api/sample-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wines: selectedWines,
            contact: {
              company: document.getElementById('company').value,
              firstName: document.getElementById('firstName').value,
              lastName: document.getElementById('lastName').value,
              email: document.getElementById('email').value,
              phone: document.getElementById('phone').value
            },
            shipping: {
              address1: document.getElementById('address1').value,
              address2: document.getElementById('address2').value,
              city: document.getElementById('city').value,
              state: document.getElementById('state').value,
              zip: document.getElementById('zip').value,
              country: document.getElementById('country').value
            },
            comments: document.getElementById('comments').value
          })
        });
        
        if (res.ok) {
          document.getElementById('app').innerHTML = `
            <div class="success-page">
              <div class="icon">‚úì</div>
              <h2>Request Submitted</h2>
              <p>Thank you! We've received your sample request and will be in touch shortly.</p>
              <p style="margin-top: 8px;">A confirmation email has been sent to your email address.</p>
              <button class="btn btn-primary" style="max-width: 300px; margin-top: 32px;" onclick="location.reload()">
                Submit Another Request
              </button>
            </div>
          `;
        } else {
          throw new Error('Submit failed');
        }
      } catch (err) {
        alert('There was an error submitting your request. Please try again or contact office@loontradingco.com');
        btn.disabled = false;
        btn.textContent = 'Submit Sample Request';
      }
    }
    
    // Populate state dropdown
    function populateStates() {
      const stateSelect = document.getElementById('state');
      if (!stateSelect || stateOptions.length === 0) return;
      
      let html = '<option value="">Select state...</option>';
      stateOptions.forEach(s => {
        html += `<option value="${s.name}">${s.name}${s.abbrev ? ` (${s.abbrev})` : ''}</option>`;
      });
      stateSelect.innerHTML = html;
    }
    
    init();
  </script>
</body>
</html>
